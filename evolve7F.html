<!DOCTYPE HTML>
<html>

<!--
The MIT License

Copyright (c) 2008 AlteredQualia

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

2008-12-16 - Martin Breidt - updated  to export SVG data from DNA

-->

<head>
<title>Image evolution</title>

<style type="text/css">
aaa { outline:dotted 1px red }
body { font-family:arial, sans-serif; padding:1em }
h2 { margin-top:1.75em }
canvas { border:solid 1px #000 }
.image { float:left; margin:0 0.5em 0 0; font-size:2em }
.clr { clear:both }
ul { list-style-type:square }
a:hover { background:#1e4881; color:white; text-decoration:none }

#algo, #dnaformat { background:#eee; padding:1em; margin-top:1em; border-left:solid 10px #999 }

.snapshot ul, .snapshot img { float:left }
.snapshot ul { margin:0 1em 1.5em 0; color:#333; width:13em }

#fitwrap { font-weight:bold; font-size:1em; color:#999; margin:2em 1em 0 0; float:left; width:15em }
#fitness, #step_benefit, #step_total { font-size:2em;}
#fitness { color:#000; }
#step_benefit { color:#0a0; }
#step_total { color:#aa0; }

#start, #stop { width:4em; margin-top:0.5em; padding:0.5em; background:black; text-align:center; float:left; cursor:pointer; font-size:2em }
#start { color:lightgreen; }
#stop { color:red; display:none }

#imgform { float:left; border:solid 0px #000; padding:0em; margin:0.5em 1em 0 0; width:40em }
#imgurl { width:35em }

.button { background:#000; color:#fff; cursor:pointer; width:3em; padding:0.2em 0.5em 0.2em 0.5em; text-align:center; display:inline }
.button:hover { background:#a00; color:white }
.warning { color:red }
.highlighted { color:yellow }

#dnaformwrap { padding:0; float:left; margin:1em 1em 0 0; }
#clipboard { width:50em; height:13em; margin:1em 0 0 0 }

#mutationtype, #resetdna { margin:0 0 0.4em 0 }
#parameters { float:left; margin:2em 0 0 0 }
.parname { margin:0 0 0.2em 0 }

#geometry { margin:1em 0 0.4em 0 }
#polygons, #vertices { font-size:2em }
.pargeo { margin:0 0 0 0.5em; position:relative; top:0.4em }
#geometry .button { font-weight:bold; width:1em;  }

dt { font-weight:bold; margin-bottom:0.5em }
dd { margin:0 0 2em 0 }
</style>

<script type="text/javascript">
var IMG_INIT ="mona_lisa_crop.jpg"; // mona_lisa_crop.jpg mondrian.jpg
var DEPTH = 4;

var INIT_TYPE = "color"; // random color
var INIT_R = 0;
var INIT_G = 0;
var INIT_B = 0;
var INIT_A = 0.001;

var mutateDNA = mutate_medium; // mutate_soft mutate_medium mutate_hard

var CANVAS_INPUT = 0;
var CANVAS_OUTPUT = 0;
var CANVAS_BEST = 0;

var CONTEXT_INPUT = 0;
var CONTEXT_TEST = 0;
var CONTEXT_BEST = 0;

var IMAGE = new Image();
var IWIDTH = 0;
var IHEIGHT = 0;
var SUBPIXELS = 0;

var EV_TIMEOUT = 0;
var EV_ID = 0;

var COUNTER_TOTAL = 0;
var COUNTER_BENEFIT = 0;

var EL_STEP_TOTAL = 0;
var EL_STEP_BENEFIT = 0;
var EL_FITNESS = 0;

var MAX_SHAPES = 50;    // max capacity
var MAX_POINTS = 6;

var ACTUAL_SHAPES = MAX_SHAPES; // current size
var ACTUAL_POINTS = MAX_POINTS;

var DNA_BEST = new Array(MAX_SHAPES);
var DNA_TEST = new Array(MAX_SHAPES);

var CHANGED_SHAPE_INDEX = 0;

var FITNESS_MAX = 999923400656;
var FITNESS_TEST = FITNESS_MAX;
var FITNESS_BEST = FITNESS_MAX;

var FITNESS_BEST_NORMALIZED = 0; // pixel match: 0% worst - 100% best
var NORM_COEF = IWIDTH*IHEIGHT*3*255; // maximum distance between black and white images

var DATA_INPUT = 0;
var DATA_TEST = 0;

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function hide(id) {
    var el = document.getElementById(id);
    if(el)
        el.style.display = "none";
}

function show(id) {
    var el = document.getElementById(id);
    if(el)
        el.style.display = "block";
}

function setElement(id, value) {
    var el = document.getElementById(id);
    if(el)
        el.innerHTML = value;
}

function setButtonHighlight(highlighted, others) {
    for(var i in others) {
        var el = document.getElementById(others[i]);
        if(el) {
            el.style.color = "white";
            el.style.background = "black";
        }
    }
    var elHighighted = document.getElementById(highlighted);
    if(elHighighted) {
        elHighighted.style.color = "white";
        elHighighted.style.background = "orange";
    }
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function rand_int(maxval) {
    return Math.round(maxval*Math.random());
}

function rand_float(maxval) {
    return maxval*Math.random();
}

function clamp(val, minval, maxval) {
    if(val<minval) return minval;
    if(val>maxval) return maxval;
    return val;
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function stop() {
    clearTimeout(EV_ID);
    hide("stop");
    show("start");
}

function start() {
    EV_ID = setInterval(evolve, EV_TIMEOUT);
    hide("start");
    show("stop");
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function addPolygon() {
    ACTUAL_SHAPES = clamp(ACTUAL_SHAPES+1, 1, 1000);
    if(ACTUAL_SHAPES>MAX_SHAPES) {
        extend_dna_polygons(DNA_TEST);
        extend_dna_polygons(DNA_BEST);
        MAX_SHAPES++;
        pass_gene_mutation(DNA_BEST, DNA_TEST, DNA_BEST.length-1);
    }
    setElement("polygons", ACTUAL_SHAPES);
    
    redrawDNA();
    refreshStats();
}

function removePolygon() {
    ACTUAL_SHAPES = clamp(ACTUAL_SHAPES-1, 1, 1000);
    setElement("polygons", ACTUAL_SHAPES);
    
    redrawDNA();
    refreshStats();    
}

function addVertex() {
    ACTUAL_POINTS = clamp(ACTUAL_POINTS+1, 3, 1000);
    if(ACTUAL_POINTS>MAX_POINTS) {
        extend_dna_vertices(DNA_TEST);
        extend_dna_vertices(DNA_BEST);
        MAX_POINTS++;
        copyDNA(DNA_BEST, DNA_TEST);
    }
    setElement("vertices", ACTUAL_POINTS);
    
    redrawDNA();
    refreshStats();
}

function removeVertex() {
    ACTUAL_POINTS = clamp(ACTUAL_POINTS-1, 3, 1000);
    setElement("vertices", ACTUAL_POINTS);

    redrawDNA();
    refreshStats();
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function setMutation(m) {
    var trans = { 'soft':[mutate_soft,"b_mut_soft"], 'medium':[mutate_medium,"b_mut_med"], 'hard':[mutate_hard,"b_mut_hard"] };
    mutateDNA = trans[m][0];
    setButtonHighlight(trans[m][1], ["b_mut_soft", "b_mut_med", "b_mut_hard"]);
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function setDnaRandom() {
    INIT_TYPE = "random";
    resetDna();
    refreshStats();
    setButtonHighlight("b_dna_random", ["b_dna_random", "b_dna_white", "b_dna_black"]);
}

function setDnaColor(r,g,b) {
    INIT_TYPE = "color";
    INIT_R = r;
    INIT_G = g;
    INIT_B = b;
    resetDna();
    refreshStats();
    if(r==0&&g==0&&b==0)
        setButtonHighlight("b_dna_black", ["b_dna_random", "b_dna_white", "b_dna_black"]);
    else
        setButtonHighlight("b_dna_white", ["b_dna_random", "b_dna_white", "b_dna_black"]);
}

function resetDna() {
    init_dna(DNA_TEST);
    init_dna(DNA_BEST);
    copyDNA(DNA_BEST, DNA_TEST);
    
    FITNESS_TEST = FITNESS_MAX;
    FITNESS_BEST = FITNESS_MAX;
    
    COUNTER_BENEFIT = 0;
    COUNTER_TOTAL = 0;

    redrawDNA();
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function refreshStats() {
    FITNESS_TEST = compute_fitness(DNA_TEST);
    FITNESS_BEST = FITNESS_TEST;
    FITNESS_BEST_NORMALIZED = 100*(1-FITNESS_BEST/NORM_COEF);
    EL_FITNESS.innerHTML = FITNESS_BEST_NORMALIZED.toFixed(2)+"%";
    
    EL_STEP_BENEFIT.innerHTML = COUNTER_BENEFIT;
    EL_STEP_TOTAL.innerHTML = COUNTER_TOTAL;
}

function redrawDNA() {
    drawDNA(CONTEXT_TEST, DNA_TEST);
    drawDNA(CONTEXT_BEST, DNA_BEST);
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function drawShape(ctx, shape, color) {
    ctx.fillStyle = "rgba("+color.r+","+color.g+","+color.b+","+color.a+")";
    ctx.beginPath();
    ctx.moveTo(shape[0].x, shape[0].y);
    for(var i=1;i<ACTUAL_POINTS;i++) {
        ctx.lineTo(shape[i].x, shape[i].y);
    }
    ctx.closePath();
    ctx.fill();
}

function drawDNA(ctx, dna) {
    ctx.fillStyle = "rgb(255,255,255)";
    ctx.fillRect(0, 0, IWIDTH, IHEIGHT);
    for(var i=0;i<ACTUAL_SHAPES;i++) {
        drawShape(ctx, dna[i].shape, dna[i].color);
    }
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function mutate_medium(dna_out) {
    CHANGED_SHAPE_INDEX = rand_int(ACTUAL_SHAPES-1);

    var roulette = rand_float(2.0);

    // mutate color
    if(roulette<1) {
        // red
        if(roulette<0.25) {
            dna_out[CHANGED_SHAPE_INDEX].color.r = rand_int(255);
        }
        // green
        else if(roulette<0.5) {
            dna_out[CHANGED_SHAPE_INDEX].color.g = rand_int(255);
        }
        // blue
        else if(roulette<0.75) {
            dna_out[CHANGED_SHAPE_INDEX].color.b = rand_int(255);
        }
        // alpha
        else if(roulette<1.0) {
            dna_out[CHANGED_SHAPE_INDEX].color.a = rand_float(1.0);
        }
    }

    // mutate shape
    else {
        var CHANGED_POINT_INDEX = rand_int(ACTUAL_POINTS-1);

        // x-coordinate
        if(roulette<1.5) {
            dna_out[CHANGED_SHAPE_INDEX].shape[CHANGED_POINT_INDEX].x = rand_int(IWIDTH);
        }

        // y-coordinate
        else {
            dna_out[CHANGED_SHAPE_INDEX].shape[CHANGED_POINT_INDEX].y = rand_int(IHEIGHT);
        }
    }
}

function mutate_hard(dna_out) {
    CHANGED_SHAPE_INDEX = rand_int(ACTUAL_SHAPES-1);

    dna_out[CHANGED_SHAPE_INDEX].color.r = rand_int(255);
    dna_out[CHANGED_SHAPE_INDEX].color.g = rand_int(255);
    dna_out[CHANGED_SHAPE_INDEX].color.b = rand_int(255);
    dna_out[CHANGED_SHAPE_INDEX].color.a = rand_float(1.0);
    var CHANGED_POINT_INDEX = rand_int(ACTUAL_POINTS-1);

    dna_out[CHANGED_SHAPE_INDEX].shape[CHANGED_POINT_INDEX].x = rand_int(IWIDTH);
    dna_out[CHANGED_SHAPE_INDEX].shape[CHANGED_POINT_INDEX].y = rand_int(IHEIGHT);
}

function mutate_soft(dna_out) {
    CHANGED_SHAPE_INDEX = rand_int(ACTUAL_SHAPES-1);

    var roulette = rand_float(2.0);

    var delta = -1+rand_int(3);

    // mutate color
    if(roulette<1) {
        // red
        if(roulette<0.25) {
            dna_out[CHANGED_SHAPE_INDEX].color.r = clamp(dna_out[CHANGED_SHAPE_INDEX].color.r+delta, 0, 255);
        }
        // green
        else if(roulette<0.5) {
            dna_out[CHANGED_SHAPE_INDEX].color.g = clamp(dna_out[CHANGED_SHAPE_INDEX].color.g+delta, 0, 255);
        }
        // blue
        else if(roulette<0.75) {
            dna_out[CHANGED_SHAPE_INDEX].color.b = clamp(dna_out[CHANGED_SHAPE_INDEX].color.b+delta, 0, 255);
        }
        // alpha
        else if(roulette<1.0) {
            dna_out[CHANGED_SHAPE_INDEX].color.a = clamp(dna_out[CHANGED_SHAPE_INDEX].color.a+0.1*delta, 0.0, 1.0);
        }
    }

    // mutate shape
    else {
        var CHANGED_POINT_INDEX = rand_int(ACTUAL_POINTS-1);

        // x-coordinate
        if(roulette<1.5) {
            dna_out[CHANGED_SHAPE_INDEX].shape[CHANGED_POINT_INDEX].x = clamp(dna_out[CHANGED_SHAPE_INDEX].shape[CHANGED_POINT_INDEX].x+delta, 0, IWIDTH);
        }

        // y-coordinate
        else {
            dna_out[CHANGED_SHAPE_INDEX].shape[CHANGED_POINT_INDEX].y = clamp(dna_out[CHANGED_SHAPE_INDEX].shape[CHANGED_POINT_INDEX].y+delta, 0, IHEIGHT);
        }
    }
}

function compute_fitness(dna) {
    var fitness = 0;

    DATA_TEST = CONTEXT_TEST.getImageData(0, 0, IWIDTH, IHEIGHT).data;

    //var f=0;
    for(var i=0;i<SUBPIXELS;++i) {
        if(i%DEPTH!=3)
            fitness += Math.abs(DATA_INPUT[i]-DATA_TEST[i]);
            //if(fitness>FITNESS_BEST) break;
            //f = DATA_INPUT[i]-DATA_TEST[i];
            //fitness += f*f;
    }

    return fitness;
}

function pass_gene_mutation(dna_from, dna_to, gene_index) {
    dna_to[gene_index].color.r = dna_from[gene_index].color.r;
    dna_to[gene_index].color.g = dna_from[gene_index].color.g;
    dna_to[gene_index].color.b = dna_from[gene_index].color.b;
    dna_to[gene_index].color.a = dna_from[gene_index].color.a;

    for(var i=0;i<MAX_POINTS;i++) {
        dna_to[gene_index].shape[i].x = dna_from[gene_index].shape[i].x;
        dna_to[gene_index].shape[i].y = dna_from[gene_index].shape[i].y;
    }
}

function copyDNA(dna_from, dna_to) {
    for(var i=0;i<MAX_SHAPES;i++)
        pass_gene_mutation(dna_from, dna_to, i);
}

function evolve() {
    mutateDNA(DNA_TEST);
    drawDNA(CONTEXT_TEST, DNA_TEST);

    FITNESS_TEST = compute_fitness(DNA_TEST);

    if(FITNESS_TEST<FITNESS_BEST) {
        pass_gene_mutation(DNA_TEST, DNA_BEST, CHANGED_SHAPE_INDEX);

        FITNESS_BEST = FITNESS_TEST;
        FITNESS_BEST_NORMALIZED = 100*(1-FITNESS_BEST/NORM_COEF);
        EL_FITNESS.innerHTML = FITNESS_BEST_NORMALIZED.toFixed(2)+"%";

        COUNTER_BENEFIT++;
        EL_STEP_BENEFIT.innerHTML = COUNTER_BENEFIT;

        drawDNA(CONTEXT_BEST, DNA_BEST);
    }
    else {
        pass_gene_mutation(DNA_BEST, DNA_TEST, CHANGED_SHAPE_INDEX);
    }

    COUNTER_TOTAL++;
    EL_STEP_TOTAL.innerHTML = COUNTER_TOTAL;
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function init_dna(dna) {
    for(var i=0;i<MAX_SHAPES;i++) {
        var points = new Array(MAX_POINTS);
        for(var j=0;j<MAX_POINTS;j++) {
            points[j] = {'x':rand_int(IWIDTH),'y':rand_int(IHEIGHT)};
        }
        var color = {};
        if(INIT_TYPE=="random")
            color = {'r':rand_int(255),'g':rand_int(255),'b':rand_int(255),'a':0.001};
        else
            color = {'r':INIT_R,'g':INIT_G,'b':INIT_B,'a':INIT_A};
        var shape = {
        'color':color,
        'shape':points
        }
        dna[i] = shape;
    }
}

function extend_dna_polygons(dna) {
    var points = new Array(MAX_POINTS);
    for(var j=0;j<MAX_POINTS;j++) {
        points[j] = {'x':rand_int(IWIDTH),'y':rand_int(IHEIGHT)};
    }
    var color = {};
    if(INIT_TYPE=="random")
        color = {'r':rand_int(255),'g':rand_int(255),'b':rand_int(255),'a':0.001};
    else
        color = {'r':INIT_R,'g':INIT_G,'b':INIT_B,'a':INIT_A};
    var shape = {'color':color, 'shape':points};
    dna.push(shape);
}

function extend_dna_vertices(dna) {
    for(var i=0;i<MAX_SHAPES;i++) {
        var point = {'x':rand_int(IWIDTH),'y':rand_int(IHEIGHT)};
        dna[i].shape.push(point);
    }
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function init_canvas() {
    CANVAS_INPUT = document.getElementById('canvas_input');
    CONTEXT_INPUT = CANVAS_INPUT.getContext('2d');

    CANVAS_TEST = document.getElementById('canvas_test');
    CONTEXT_TEST = CANVAS_TEST.getContext('2d');

    CANVAS_BEST = document.getElementById('canvas_best');
    CONTEXT_BEST = CANVAS_BEST.getContext('2d');

    IWIDTH = IMAGE.width;
    IHEIGHT = IMAGE.height;

    SUBPIXELS = IWIDTH*IHEIGHT*DEPTH;
    NORM_COEF = IWIDTH*IHEIGHT*3*255;
    
    CANVAS_INPUT.setAttribute('width',IWIDTH);
    CANVAS_INPUT.setAttribute('height',IHEIGHT);

    CANVAS_TEST.setAttribute('width',IWIDTH);
    CANVAS_TEST.setAttribute('height',IHEIGHT);

    CANVAS_BEST.setAttribute('width',IWIDTH);
    CANVAS_BEST.setAttribute('height',IHEIGHT);

    // draw the image onto the canvas
    CONTEXT_INPUT.drawImage(IMAGE, 0, 0, IWIDTH, IHEIGHT);

    DATA_INPUT = CONTEXT_INPUT.getImageData(0, 0, IWIDTH, IHEIGHT).data;

    EL_STEP_TOTAL = document.getElementById("step_total");
    EL_STEP_BENEFIT = document.getElementById("step_benefit");
    EL_FITNESS = document.getElementById("fitness");

    init_dna(DNA_TEST);
    init_dna(DNA_BEST);
    copyDNA(DNA_BEST, DNA_TEST);

    redrawDNA();
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function serializeDNA(dna) {
    var dna_string = "";

    // header
    dna_string += ACTUAL_POINTS+" ";
    dna_string += ACTUAL_SHAPES+" ";

    // shapes
    for(var i=0;i<ACTUAL_SHAPES;i++) {
        dna_string += dna[i].color.r+" ";
        dna_string += dna[i].color.g+" ";
        dna_string += dna[i].color.b+" ";
        dna_string += dna[i].color.a+" ";
        for(var j=0;j<ACTUAL_POINTS;j++) {
            dna_string += dna[i].shape[j].x+" ";
            dna_string += dna[i].shape[j].y+" ";
        }
    }
    return dna_string;
}

function serializeDNAasSVG(dna) {
	// output DNA string in SVG format
    var dna_string = "";

    // header
	dna_string += "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n";
	dna_string += "<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\" \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n";   
	dna_string += "<svg xmlns=\"http://www.w3.org/2000/svg\"\n";
    dna_string += "xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns:ev=\"http://www.w3.org/2001/xml-events\"\n";
    dna_string += "version=\"1.1\" baseProfile=\"full\"\n";
    dna_string += "width=\"800mm\" height=\"600mm\">\n";

    // shapes
    for(var i=0;i<ACTUAL_SHAPES;i++) {
		dna_string += "<polygon points=\"";
        for(var j=0;j<ACTUAL_POINTS;j++) {
            dna_string += dna[i].shape[j].x+" ";
            dna_string += dna[i].shape[j].y+" ";
        }
		dna_string += "\" fill=\"rgb(";
        dna_string += dna[i].color.r+",";
        dna_string += dna[i].color.g+",";
        dna_string += dna[i].color.b+")\" opacity=\"";
        dna_string += dna[i].color.a+"\" />\n";
    }
	dna_string +=  "<\/svg>\n";
    return dna_string;
}

function deserializeDNA(dna, text) {
    var data = text.split(" ");

    MAX_POINTS = parseInt(data[0]);
    MAX_SHAPES = parseInt(data[1]);
        
    ACTUAL_SHAPES = MAX_SHAPES;
    ACTUAL_POINTS = MAX_POINTS;

    alert("Importing "+MAX_SHAPES+" polygons ["+MAX_POINTS+"-vertex] ["+data.length+" numbers]...");

    init_dna(dna);

    var shape_size = 4+2*MAX_POINTS;

    for(var i=0;i<MAX_SHAPES;i++) {
        dna[i].color.r = parseInt(data[2+i*shape_size+0]);
        dna[i].color.g = parseInt(data[2+i*shape_size+1]);
        dna[i].color.b = parseInt(data[2+i*shape_size+2]);
        dna[i].color.a = parseFloat(data[2+i*shape_size+3]);
        for(var j=0;j<MAX_POINTS;j++) {
            dna[i].shape[j].x = parseInt(data[2+i*shape_size+4+j*2]);
            dna[i].shape[j].y = parseInt(data[2+i*shape_size+4+j*2+1]);
        }
    }
}

function export_dna() {
    var el = document.getElementById("clipboard");
    if(el)
        el.value = serializeDNA(DNA_BEST);
    else
        alert("Cannot find clipboard");
}

function export_dna_as_svg() {
    var el = document.getElementById("clipboard");
    if(el)
        el.value = serializeDNAasSVG(DNA_BEST);
    else
        alert("Cannot find clipboard");
}

function import_dna() {
    var el = document.getElementById("clipboard");
    if(el) {
        deserializeDNA(DNA_BEST, el.value);

        init_dna(DNA_TEST);
        copyDNA(DNA_BEST, DNA_TEST);        

        redrawDNA();
        refreshStats();
        
        setElement("polygons", ACTUAL_SHAPES);
        setElement("vertices", ACTUAL_POINTS);
    }
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function set_image() {
    var el = document.getElementById("imgurl");
    if(el) {
        IMAGE.onload = function() {
            // hack around onload bug
            if(IMAGE.complete) {
                init_canvas();
            }
            else {
                setTimeout(init_canvas, 100);
            }
        }
        IMAGE.src = "http://alteredqualia.com/visualization/evolve/proxy.php?i="+el.value;
    }
}

function set_example_image(lnk) {
    if(lnk) {
        var el = document.getElementById("imgurl");
        el.value = lnk.href;
        IMAGE.src = lnk.href;
        IMAGE.onload = function() {
            // hack around onload bug
            if(IMAGE.complete) {
                init_canvas();
            }
            else {
                setTimeout(init_canvas, 100);
            }
        }
    }
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function select_all()
{
    var text_val = document.dnaform.clipboard;
    text_val.focus();
    text_val.select();
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function init() {
    IMAGE.onload = function() {
        // hack to work around ugly, ugly bug
        // onload event firing is unreliable
        // as image data may not be ready yet!!!
        if(IMAGE.complete) {
            init_canvas();
        }
        else {
            setTimeout(init_canvas, 100);
        }
    }
    IMAGE.src = IMG_INIT;
    
    setButtonHighlight("b_dna_black", ["b_dna_random", "b_dna_white", "b_dna_black"]);
    setButtonHighlight("b_mut_med", ["b_mut_soft", "b_mut_med", "b_mut_hard"]);
}
</script>

<body onload="init()">
    <div class="image">
        Original<br/>
        <canvas id="canvas_input"></canvas>
    </div>

    <div class="image">
        Best<br/>
        <canvas id="canvas_best"></canvas>
    </div>

    <div class="image">
        Evolving<br/>
        <canvas id="canvas_test"></canvas>
    </div>

    <div id="fitwrap">
        <span id="step_benefit">0</span> Improvements<br/>
        <span id="step_total">0</span> Mutations<br/>
        <span id="fitness">?</span> Fitness<br/>

        <div id="start" onclick="start()">Start</div>
        <div id="stop" onclick="stop()">Stop</div>
    </div>
        
    <br class="clr"/>
    
    <div id="imgform">
        <form>
            <div class="button" id="b_setimage" onclick="set_image()">Set new image URL</div>
            <input id="imgurl"></input>
        </form>
        <small style="color:#555;">Image should be small (~200x200 pixels), otherwise fitness computation is very slow. 
        <p>Examples:
        <a onclick="set_example_image(this); return false;" href="http://alteredqualia.com/visualization/evolve/mona_lisa_crop.jpg">Mona Lisa</a>
        <a onclick="set_example_image(this); return false;" href="http://alteredqualia.com/visualization/evolve/darwin_crop.jpg">Darwin</a>
        <a onclick="set_example_image(this); return false;" href="http://alteredqualia.com/visualization/evolve/velociraptor2_crop.jpg">Velociraptor</a>
        <a onclick="set_example_image(this); return false;" href="http://alteredqualia.com/visualization/evolve/koza_crop.jpg">John Koza</a>
        </small>
    </div>
    
    <br class="clr"/>
    
    <div id="dnaformwrap">
        <form name="dnaform">
            <div class="button" id="b_export_dna" onclick="export_dna()">Export DNA</div>
            <div class="button" id="b_export_svg" onclick="export_dna_as_svg()">Export SVG</div>
            <div class="button" id="b_import_dna" onclick="import_dna()">Import DNA</div>
            <a href="#export_note">[help]</a>
            <br/>
            <textarea name="clipboard" id="clipboard" onClick="select_all();"></textarea>
        </form>
    </div>
    
    
    <div id="parameters">
        <div id="mutationtype">
            <div class="parname">Mutation</div>
            <div class="button" id="b_mut_soft" onclick="setMutation('soft')">Soft</div>
            <div class="button" id="b_mut_med" onclick="setMutation('medium')">Medium</div>
            <div class="button" id="b_mut_hard" onclick="setMutation('hard')">Hard</div>
        </div>
        
        <div id="resetdna">
            <div class="parname">Initialize DNA</div>
            <div class="button" id="b_dna_random" onclick="setDnaRandom()">Color</div>
            <div class="button" id="b_dna_white" onclick="setDnaColor(254,254,254)">White</div>
            <div class="button" id="b_dna_black" onclick="setDnaColor(0,0,0)">Black</div>
        </div>
        
        <div id="geometry">
            <div class="button" onclick="removePolygon()">-</div> <div class="button" onclick="addPolygon()">+</div> <span class="parname pargeo"><span id="polygons">50</span> Polygons</span> <br/>
            <div class="button" onclick="removeVertex()">-</div> <div class="button" onclick="addVertex()">+</div> <span class="parname pargeo"><span id="vertices">6</span> Vertices</span> 
        </div>
    </div>

    <br class="clr"/>

    <!----------- YOU CAN CUT AWAY ANYTHING BELOW HERE IF YOU WANT JUST THE ALGORITHM (INCLUDING ITS USER INTERFACE) -------------->

    <div id="text">

    <h2>What is this?</h2>

    A <a href="http://en.wikipedia.org/wiki/Simulated_Annealing">simulated annealing</a> like optimization algorithm, a reimplementation of
    <a href="http://rogeralsing.com/2008/12/07/genetic-programming-evolution-of-mona-lisa/">Roger Alsing's excellent idea</a>.

    <div id="algo">
        The goal is to get an <b>image represented as a collection of overlapping polygons of various colors and transparencies</b>.

        <p>We start from random 50 polygons that are invisible. In each optimization step we randomly modify one parameter
        (like color components or polygon vertices) and check whether such new variant looks more like the original image.
        If it is, we keep it, and continue to mutate this one instead.

        <p><strike>Fitness is a sum of pixel-by-pixel differences from the original image. Lower number is better.</strike><br/>
        Displayed fitness is now a percentage of how close the new image is to the original one (1-current difference/maximum difference). The best possible is 100%.
        This new fitness is normalized so that it's easier to compare different images and different sizes.
    </div>

    <p>This implementation is based on Roger Alsing's description, though not on his code. There are probably some subtle differences
    in how the mutations are done, how the polygons are represented and how the fitness is computed as I tried to figure out how to
    have it running reasonably fast in JavaScript + &lt;canvas&gt; environment.

    <h2>How does it look after some time?</h2>
    <div class="snapshot">
        <img src="4points15min.jpg"/>
        <ul>
            <li>50 polygons (4-vertex)</li>
            <li>~15 minutes</li>
            <li>644 benefitial mutations</li>
            <li>6,120 candidates</li>
            <li>3,445,440 fitness (88.74%)</li>
        </ul>
    </div>
    <div class="snapshot">
        <img src="6points15min.jpg"/>
        <ul>
            <li>50 polygons (6-vertex)</li>
            <li>~15 minutes</li>
            <li>646 benefitial mutations</li>
            <li>6,024 candidates</li>
            <li>3,354,804 fitness (89.04%)</li>
        </ul>
    </div>
    <div class="snapshot">
        <img src="10points15min.jpg"/>
        <ul>
            <li>50 polygons (10-vertex)</li>
            <li>~15 minutes</li>
            <li>645 benefitial mutations</li>
            <li>5,367 candidates</li>
            <li>3,976,291 fitness (87.01%)</li>
        </ul>
    </div>

    <br class="clr"/>
    <br class="clr"/>

    <div class="snapshot">
        <img src="6points45min.jpg"/>
        <ul>
            <li>50 polygons (6-vertex)</li>
            <li>~45 minutes</li>
            <li>1,476 benefitial mutations</li>
            <li>23,694 candidates</li>
            <li>2,035,741 fitness (93.35%)</li>
        </ul>
    </div>

    <div class="snapshot">
        <img src="6points60min.jpg"/>
        <ul>
            <li>50 polygons (6-vertex)</li>
            <li>~60 minutes</li>
            <li>1,595 benefitial mutations</li>
            <li>28,888 candidates</li>
            <li>2,000,044 fitness (93.46%)</li>
        </ul>
    </div>

    <div class="snapshot">
        <img src="6points120min.jpg"/>
        <ul>
            <li>50 polygons (6-vertex)</li>
            <li>~120 minutes</li>
            <li>1,966  benefitial mutations</li>
            <li>50,500 candidates</li>
            <li>1,868,736 fitness (93.89%)</li>
        </ul>
    </div>

    <br class="clr"/>
    <br class="clr"/>

    <div class="snapshot">
        <img src="mona_9636.png"/>
        <ul style="margin-top:-0.5em">
            <li>50 polygons (6-vertex)</li>
            <li>~2 days</li>
            <li>7,425 benefitial mutations</li>
            <li>5,288,801 candidates</li>
            <li>1,114,038 fitness (96.36%)</li>
            <li><small>Thanks to Julian.</small></li>
        </ul>
    </div>

    <br class="clr"/>

    <h2>Does it work on all images?</h2>

    It depends, success varies. The best seem to be color images with well defined features.
    <br/>
    <br/>

    <div class="snapshot">
        <img src="darwin_tiny.jpg" style="margin-right:0.25em"/>
        <img src="6points15min-darwin.jpg"/>
        <img src="6points60min-darwin.jpg"/>
        <img src="darwin_9597.png"/>
        <ul style="margin-top:-0.5em">
            <li>50 polygons (6-vertex)</li>
            <li>4,358 benefitial mutations</li>
            <li>227,852 candidates</li>
            <li>95.97% fitness</li>
            <li><small>Thanks to Quialiss.</small></li>
            <li><small>Images from different runs.</small></li>
        </ul>
    </div>

    <br class="clr"/>

    <div class="snapshot">
        <img src="velociraptor_tiny.jpg" style="margin-right:0.25em"/>
        <img src="6points15min-velociraptor.jpg"/>
        <img src="6points60min-velociraptor.jpg"/>
        <img src="velociraptor_9524.jpg"/>
        <ul>
            <li>50 polygons (6-vertex)</li>
            <li>718+ benefitial mutations</li>
            <li>22,440+ candidates</li>
            <li>95.24% fitness</li>
            <li><small>Images from different runs.</small></li>
        </ul>
    </div>

    <br class="clr"/>

    <div class="snapshot">
        <img src="firefox_tiny.jpg" style="margin-right:0.25em"/>
        <img src="firefox_9476.png"/>
        <img src="firefox_9568.png"/>
        <img src="firefox_9503.png"/>
        <ul>
            <li>100 polygons (5-vertex)</li>
            <li>10,490 benefitial mutations</li>
            <li>2,161,018 candidates</li>
            <li>95.03% fitness</li>
            <li><small>Thanks to <a href="http://news.ycombinator.com/item?id=393998">Asa</a>, Will, Nic &amp; Yuku.</small></li>
            <li><small>Images from different runs.</small></li>
        </ul>
    </div>

    <br class="clr"/>

    <div class="snapshot">
        <img src="mondrian_tiny.jpg" style="margin-right:0.25em"/>
        <img src="mondrian_2991784x.jpg"/>
        <img src="mondrian_75485924.jpg"/>
        <ul>
            <li>50 polygons (6-vertex)</li>
            <li>6,280 benefitial mutations</li>
            <li>683,806 candidates</li>
            <li><small>Thanks to <a href="http://www.reddit.com/r/programming/comments/7iglm/evolution_of_mona_lisa_in_javascript_canvas_use/c06r7m9">alexs</a> for the final image.</small></li>
            <li><small>Images from different runs.</small></li>
        </ul>
    </div>

    <br class="clr"/>

    <div class="snapshot">
        <img src="opera_9568.png"/>
        <ul style="margin-top:0.0em">
            <li>100 polygons (5-vertex)</li>
            <li>6,974 benefitial mutations</li>
            <li>2,056,467  candidates</li>
            <li>95.68% fitness</li>
            <li><small>Thanks to Yuku.</small></li>
        </ul>
    </div>

    <br class="clr"/>

    <div class="snapshot">
        <img src="cube.jpg" style="margin-right:0.25em"/>
        <img src="cube_504973.jpg"/>
        <ul style="margin-top:0.5em">
            <li>50 polygons (6-vertex)</li>
            <li>4,296 benefitial mutations</li>
            <li>2,404,942 candidates</li>
            <li>97.6% fitness</li>
            <li><small>Thanks to <a href="http://teque5.com">Kyle</a>.</small></li>
        </ul>
    </div>

    <br class="clr"/>


    <div class="snapshot">
        <img src="krhainos.gif" style="margin-right:0.25em"/>
        <img src="krhainos_9384.jpg"/>
        <ul>
            <li>50 polygons (6-vertex)</li>
            <li>10,605 benefitial mutations</li>
            <li>11,104,153 candidates</li>
            <li>93.84% fitness</li>
            <li><small>Thanks to <a href="http://dingo9.net">KRHAiNOS</a>.</small></li>
        </ul>
    </div>

    <br class="clr"/>

    <div class="snapshot">
        <img src="firefox_9504.png"/>
        <ul style="margin-top:0.0em">
            <li>50 polygons (6-vertex)</li>
            <li>11,147 benefitial mutations</li>
            <li>1,021,165 candidates</li>
            <li>95.04% fitness</li>
            <li><small>Thanks to Simon.</small></li>
        </ul>
    </div>

    <br class="clr"/>

    <small>See also <a href="http://video.google.com/videoplay?docid=-3161308595667510942">Firefox logo evolution video</a>. Thanks to Brooss.</small>

    <h2 id="export_note">What is DNA import/export?</h2>

    <span class="warning">Warning: Another experimental <strike>(that is not tested at all)</strike> feature. Most of the bugs should be fixed now.</span>

    <p>Click <b>Export DNA</b> to copy polygon representation of the current best image to the clipboard. You can use it to save your optimization state,
    for example to send it to somebody by mail or post it on the web.

    <p>If you have such saved DNA string, you can later on paste it into the clipboard and click on <b>Import DNA</b>. This should reproduce the optimization state
    from the time it was saved via export.

    <p>Please note that DNA is independent of the original image. It means that if you used a custom image, you should also set this image (via image form) to reproduce
    a complete state. (Or you could play with switching images/DNA midway)

    <div id="dnaformat">
    DNA format is very simple (all numbers are INTs except for ALPHA which is FLOAT):
    <pre>NUMBER_OF_VERTICES NUMBER_OF_POLYGONS R G B ALPHA X0 Y0 X1 Y1 ... XN YN ... R G B ALPHA X0 Y0 X1 Y1 ... XN YN ...</pre>
    </div>

    <p>Click <b>Export DNA as SVG</b> to get <a href="http://en.wikipedia.org/wiki/Scalable_Vector_Graphics">vector image</a> from your current best DNA.
    Thanks to <a href="http://www.breidt.net/">Martin</a> for SVG export.

    <h2>Requirements</h2>

    Unfortunately, due to required <a href="http://en.wikipedia.org/wiki/Canvas_(HTML_element)">&lt;canvas&gt;</a>
    <b>getImageData</b> method support, this particular implementation works only on few browsers.

    <p>Tested and works on:
    <ul style="color:green">
        <li>WebKit nightly 39090 <a href="http://trac.webkit.org/wiki/SquirrelFish">(very fast)</a></li>
        <li>Firefox 3.1 Beta 2 <a href="http://arstechnica.com/news.ars/post/20080822-firefox-to-get-massive-javascript-performance-boost.html">(very fast)</a></li>
        <li>Firefox 3.0.4 (fast)</li>
        <li>Opera 9.61</li>
    </ul>

    Tested and doesn't work on:
    <ul style="color:red">
        <li>Safari 3.1.2</li>
        <li>Chrome 0.4.154.29 / 1.0.154.36</li>
        <li>Explorer 7</li>
    </ul>

    It may work on development versions of Safari and be faster on development versions of Firefox and Opera.
    </div>

    <h2>Frequently asked questions</h2>

    <dl>
    <dt>[Q] I want to play with the algorithm, but my local copy doesn't want to run. What should I do?</dt>

    <dd>[A] The problem is JavaScript's <a href="http://en.wikipedia.org/wiki/Same_origin_policy">same origin security policy</a>.
    You must access the page via local webserver using <b>http://localhost</b> instead of just <b>file://</b>. You can use for example Apache from <a href="http://en.wikipedia.org/wiki/Xampp">XAMPP</a>.

    <p>Then it would still work just on local images (located at the same server, access via "http://"). If you want to access images from remote sites, you need to work around,
    for example by creating a proxy, so that images would be coming from your server. <a href="http://sk.php.net/manual/en/function.curl-init.php">PHP Curl</a> is one possible way
    how to do a simple proxy.
    </dd>

    <dt>[Q] How do I compute a new fitness from the old one?</dt>

    <dd>[A] new fitness = 100 * (1 - old fitness / (width*height*3*255))</dd>

    <dt>[Q] Can I have a compiled version to run it really fast on my computer locally?</dt>
    <dd>[A] You can download Roger Alsing's <a href="http://rogeralsing.com/2008/12/11/genetic-programming-mona-lisa-source-code-and-binaries/">original binaries and C# sources</a>.
    Also there is a <a href="http://github.com/mackstann/mona/tree/master">C version for Linux</a> by Nick Welch.</dd>

    </dl>

    <h2>Contact</h2>

    If you have any questions, suggestions, comments, you can send me a <a href="mailto:postfilter@gmail.com">mail</a>.

    Or you can check <a href="http://news.ycombinator.com/item?id=392036">Hacker News</a> or
    <a href="http://www.reddit.com/r/programming/comments/7iglm/evolution_of_mona_lisa_in_javascript_canvas_use/">Reddit</a> comments for this page.

    <p>Feel free to improve on my implementation. The code is rather ugly, though some ugliness is there for performance reasons.

    <p>Source is released under <a href="http://en.wikipedia.org/wiki/Mit_license">MIT License</a>.


 </body>
</html>